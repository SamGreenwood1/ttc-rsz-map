<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TTC Reduced Speed Zone Tracker</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
  </head>
  <body>
    <header>
      <h1>TTC Reduced Speed Zone Tracker</h1>
      <!-- Future nav links can go here -->
    </header>

    <main>
      <aside>
        <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">«</button>
        <h2>Information & Filters</h2>

        <div class="filter-group">
          <h3>Filter by Line (Placeholder)</h3>
          <label><input type="checkbox" name="line1" checked /> Line 1</label>
          <label><input type="checkbox" name="line2" checked /> Line 2</label>
          <label><input type="checkbox" name="line4" checked /> Line 4</label>
        </div>

        <h3>Active Reduced Speed Zones</h3>
        <ul id="active-zones-list">
          <!-- Zones will be populated by JavaScript -->
          <li>Loading zones...</li>
        </ul>

        <h3>Legend</h3>
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="display:inline-block;width:24px;height:6px;background:#F8C300;opacity:0.4;margin-right:8px;"></span>
            <span>Line 1 (Regular)</span>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="display:inline-block;width:24px;height:6px;background:#F8C300;margin-right:8px;"></span>
            <span>Line 1 (Reduced Speed Zone)</span>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="display:inline-block;width:24px;height:6px;background:#00923F;opacity:0.4;margin-right:8px;"></span>
            <span>Line 2 (Regular)</span>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="display:inline-block;width:24px;height:6px;background:#00923F;margin-right:8px;"></span>
            <span>Line 2 (Reduced Speed Zone)</span>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="display:inline-block;width:24px;height:6px;background:#A21A68;opacity:0.4;margin-right:8px;"></span>
            <span>Line 4 (Regular)</span>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="display:inline-block;width:24px;height:6px;background:#A21A68;margin-right:8px;"></span>
            <span>Line 4 (Reduced Speed Zone)</span>
          </div>
        </div>
      </aside>

      <div id="map-container">
        <div id="map"></div>
      </div>
    </main>

    <footer>
      <p>
        Data based on publicly available information and subject to change.
      </p>
      <p>
        This is an unofficial tool. Always refer to official
        <a href="https://www.ttc.ca" target="_blank" rel="noopener noreferrer"
          >TTC sources</a
        >
        for the latest updates.
      </p>
      <p>&copy; 2025 Sam Greenwood</p>
    </footer>

    <script>
      let map; // Make map globally accessible for functions
      const geoJsonLayers = {}; // To store references to GeoJSON layers for filtering

      // Sidebar toggle logic
      document.addEventListener("DOMContentLoaded", function () {
        const aside = document.querySelector("aside");
        const toggleBtn = document.getElementById("sidebarToggle");
        let collapsed = false;
        toggleBtn.addEventListener("click", function () {
          collapsed = !collapsed;
          aside.classList.toggle("aside-collapsed", collapsed);
          toggleBtn.innerText = collapsed ? "»" : "«";
        });
      });

      function showError(message) {
        const mapDiv = document.getElementById("map");
        mapDiv.innerHTML = `<div style='padding:2rem;text-align:center;color:#b00;font-weight:bold;font-size:1.2rem;'>${message}<br><br><a href='https://www.ttc.ca/service-alerts' target='_blank' style='color:#da251d;text-decoration:underline;'>Check the official TTC Service Alerts</a></div>`;
      }

      // Initialize the map
      function initMap() {
        map = L.map("map").setView([43.665, -79.385], 12); // Centered on Toronto

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution:
            '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        // Load regular lines first
        Promise.all([
          fetch("lines/line1.json").then(r => {
            if (!r.ok) throw new Error("Failed to load Line 1 data");
            return r.json();
          }),
          fetch("lines/line2.json").then(r => {
            if (!r.ok) throw new Error("Failed to load Line 2 data");
            return r.json();
          }),
          fetch("lines/line4.json").then(r => {
            if (!r.ok) throw new Error("Failed to load Line 4 data");
            return r.json();
          })
        ]).then(([line1, line2, line4]) => {
          // Draw regular lines
          drawLineGeoJson(line1, "Line 1");
          drawLineGeoJson(line2, "Line 2");
          drawLineGeoJson(line4, "Line 4");
          // Now load speed zones
          fetch("speed_zones.geojson").then(r => {
            if (!r.ok) throw new Error("Failed to load reduced speed zones");
            return r.json();
          }).then(speedZones => {
            if (speedZones.features && speedZones.features.length > 0) {
              const speedZoneLayer = L.geoJSON(speedZones, {
                style: styleSpeedZone,
                onEachFeature: onEachFeature,
              }).addTo(map);
              // Store layer for potential filtering later
              geoJsonLayers["speedZones"] = speedZoneLayer;
            } else {
              // This case should ideally be handled by the loadSpeedZones function,
              // but as a fallback, we can clear the list if no zones are found.
              document.getElementById("active-zones-list").innerHTML = "<li>No active reduced speed zones found.</li>";
            }
          }).catch(err => {
            showError("There was a problem loading reduced speed zones. Please check the TTC's list for the latest information.");
          });
        }).catch(err => {
          showError("There was a problem loading subway line data. Please check the TTC's list for the latest information.");
        });
      }

      // Draw regular TTC lines from GeoJSON
      function drawLineGeoJson(geojson, lineKey) {
        // Lighter/transparent version for regular service
        const lineColorsRegular = {
          "Line 1": "rgba(248,195,0,0.4)",
          "Line 2": "rgba(0,146,63,0.4)",
          "Line 4": "rgba(162,26,104,0.4)"
        };
        L.geoJSON(geojson, {
          filter: f => f.properties.type === "tracks",
          style: {
            color: lineColorsRegular[lineKey] || "#888",
            weight: 5,
            opacity: 0.7
          }
        }).addTo(map);
      }

      // Style for speed zones
      function styleSpeedZone(feature) {
        // Official TTC line colors
        const lineColors = {
          "Line 1": "#F8C300",
          "Line 2": "#00923F",
          "Line 4": "#A21A68"
        };
        // Lighter/transparent version for regular service
        const lineColorsRegular = {
          "Line 1": "rgba(248,195,0,0.4)",
          "Line 2": "rgba(0,146,63,0.4)",
          "Line 4": "rgba(162,26,104,0.4)"
        };
        // Determine line key
        let lineKey = "";
        if (feature.properties.line.includes("Line 1")) lineKey = "Line 1";
        else if (feature.properties.line.includes("Line 2")) lineKey = "Line 2";
        else if (feature.properties.line.includes("Line 4")) lineKey = "Line 4";
        // Reduced speed zone if speed_kph < 30 (arbitrary threshold)
        const isReduced = feature.properties.speed_kph && feature.properties.speed_kph < 30;
        return {
          color: isReduced ? lineColors[lineKey] : lineColorsRegular[lineKey] || "#888",
          weight: isReduced ? 7 : 5,
          opacity: isReduced ? 0.9 : 0.7,
        };
      }

      // Popup content for speed zones
      function onEachFeature(feature, layer) {
        if (feature.properties) {
          let popupContent = `<h3>Reduced Speed Zone</h3>
            <strong>Line:</strong> ${feature.properties.line}<br>
            <strong>Direction:</strong> ${feature.properties.direction || "N/A"}<br>
            <strong>Between:</strong> ${feature.properties.start_station} and ${feature.properties.end_station}<br>
            <strong>Reduced Speed:</strong> ${feature.properties.speed_kph} km/h<br>
            <strong>Reason:</strong> ${feature.properties.reason}`;
          layer.bindPopup(popupContent);

          // Add to active zones list
          addZoneToList(feature, layer);
        }
      }

      // Add a zone to the sidebar list
      function addZoneToList(feature, layer) {
        const list = document.getElementById("active-zones-list");
        const listItem = document.createElement("li");
        listItem.innerHTML = `<strong>${feature.properties.line}</strong>
                                <span>${feature.properties.start_station} &harr; ${feature.properties.end_station}</span>`;
        listItem.onclick = () => {
          map.fitBounds(layer.getBounds().pad(0.2)); // Zoom to the zone
          layer.openPopup();
        };
        list.appendChild(listItem);
      }

      // Load speed zones from GeoJSON
      function loadSpeedZones() {
        const list = document.getElementById("active-zones-list");
        list.innerHTML = ""; // Clear "Loading..." or previous items

        fetch("speed_zones.geojson")
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                "Network response was not ok " + response.statusText
              );
            }
            return response.json();
          })
          .then((data) => {
            if (data.features && data.features.length > 0) {
              const speedZoneLayer = L.geoJSON(data, {
                style: styleSpeedZone,
                onEachFeature: onEachFeature,
              }).addTo(map);
              // Store layer for potential filtering later
              geoJsonLayers["speedZones"] = speedZoneLayer;
            } else {
              list.innerHTML = "<li>No active reduced speed zones found.</li>";
            }
          })
          .catch((error) => {
            console.error(
              "Error loading or parsing speed zone data:",
              error
            );
            list.innerHTML =
              "<li>Error loading speed zone data.</li>";
            alert(
              "Could not load speed zone data. Check the console for errors."
            );
          });
      }

      // Initialize the map when the DOM is ready
      document.addEventListener("DOMContentLoaded", initMap);

      // Basic Filter Logic (Placeholder - needs more work for actual filtering)
      // This is a very simplified example. Real filtering would involve
      // removing/adding layers or changing their styles.
      document
        .querySelectorAll('.filter-group input[type="checkbox"]')
        .forEach((checkbox) => {
          checkbox.addEventListener("change", () => {
            // For now, just log. Actual filtering is more complex.
            console.log(
              `Filter for ${checkbox.name} changed to ${checkbox.checked}`
            );
            // To implement actual filtering, you'd need to:
            // 1. Iterate through your geoJsonLayers.speedZones.getLayers()
            // 2. Check feature.properties.line against the checkbox states
            // 3. Either remove/add the layer from the map, or change its style to hide/show it.
            // This can get complex if you have many layers or complex filter criteria.
            // A simpler approach for this prototype might be to re-fetch/re-render
            // based on filter criteria if your dataset is small.
            alert(
              "Filter functionality is a placeholder in this prototype."
            );
          });
        });
    </script>
  </body>
</html>